#!/usr/bin/env node

/********************
 * Node-HackerNews
 *
 * A simple CLI app that reads in HackerNews's frontpage and colorizes it
 *
 * by Nick Donohue
 * forked from https://github.com/kamranayub/node-reddit. Thanks!
 * License: WTFPL (http://sam.zoy.org/wtfpl/)
 * Attribution is cool but not required
 ********************/

var program = require('commander'), 
    http    = require('http'),
    request = require('request'),
    colors  = require('colors'),
    string  = require('string'),
    openurl = require('openurl')

program
  .version('0.2.0')
  .usage('hn [OPTIONS] [ARTICLE_NO]')
  .option('-c, --comments', 'open comments URL for article instead')
  .option('-a, --all', 'open both article and comments page')
  .option('-n, --number <n>', 'number of articles to display', parseInt, 28)
  .parse(process.argv);

var requestURL = 'http://api.ihackernews.com/page',
    commentsURL = 'http://news.ycombinator.com/item?id=';

var getNews = function(callback) {
  request(requestURL, function (err, res, body) {
    if (!err && res.statusCode === 200) {
      var hn = JSON.parse(body),
          stories = hn.items; 
      stories.forEach(callback);
    }
  }); 
};

(function () {

  var article = program.args[0];

  if (article) {
    if (string(article).isNumeric()) {
      getNews(function(story,index) {

        if (parseInt(article) === index) {

          if (program.comments) {
            openurl.open(commentsURL + story.id);
          }

          else if (program.all) {
            openurl.open(story.url);
            openurl.open(commentsURL + story.id);
          }

          else {
            openurl.open(story.url);
          }

        }
      });
    }
    else {
      console.log(help);
    }
  }

  else {
    getNews(function(story,index) {
      if (index > program.number-1) return;
      var row = "",
        title = story.title.length > 100
              ? story.title.substr(0, 100) + "..." 
              : story.title;

      row += ((index < 10? " ":"") + index.toString()).green;
      row += "\t" + title;
      row += "\n";

      console.log(row);
    });
  }
})();
